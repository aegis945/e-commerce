{% extends "auctions/layout.html" %}

{% block title %}{{ listing.item_name }}{% endblock %}

{% block body %}
    <div class="container my-4">
        <div class="row">
            <div class="col-md-6">
                {% if listing.image_url %}
                    <div class="card mb-4">
                        <img src="{{ listing.image_url }}" class="card-img-top img-fluid" alt="{{ listing.item_name }}" style="object-fit: contain;">
                    </div>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h2 class="card-title mb-4">{{ listing.item_name }}</h2>
                <p class="card-text"><strong>Description:</strong> {{ listing.description }}</p>
                <p class="card-text"><strong>Current Maximum Bid:</strong> {{ listing.current_bid }}â‚¬ {% if listing.winner != listing.owner %} by {{ listing.winner }} {% endif %}</p>
                <p class="card-text"><strong>Category:</strong> {{ listing.category }}</p>
                <p class="card-text"><strong>Created:</strong> {{ listing.creation_date }}</p>
                <p class="card-text"><strong>Posted By User:</strong> {{ listing.owner }}</p>

                {% if user.is_authenticated and listing.is_active %}
                    <form action="{% url 'auctions:toggle_watchlist' listing.id %}" method="post" class="mt-3">
                    {% csrf_token %}
                        <button type="submit" class="btn {% if listing in user.watchlist.all %}btn-danger{% else %}btn-primary{% endif %}">
                        {% if listing in user.watchlist.all %}
                            Remove From Watchlist
                        {% else %}
                            Add To Watchlist
                        {% endif %}
                        </button>
                    </form>
                {% endif %}
                
                {% if user.is_authenticated and user != listing.owner and listing.is_active %}
                    <div class="mt-4">
                        <form action="{% url 'auctions:bid_on_listing' listing.id %}" method="post">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="bid_amount"><strong>Your Bid:</strong></label>
                                <div class="input-group">
                                    <input type="number" step="0.01" name="bid_amount" class="form-control" required placeholder="Enter your bid amount" value="{{ listing.current_bid }}">
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary">Place Bid</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        {% if messages %}
                        <div class="alert alert-info" role="alert">
                            {% for message in messages %}
                                {{ message }}<br>
                            {% endfor %}
                        </div>
                    {% endif %}
                    </div>
                    {% if message %}
                        <div class="alert alert-warning">{{ message }}</div>
                    {% endif %}
                {% endif %}

                {% if user.is_authenticated and user == listing.owner and listing.is_active %}
                    <div class="mt-4">
                        <form action="{% url 'auctions:close_auction' listing.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Close Auction</button>
                    </form>
                    </div>
                {% endif %}

                {% if not listing.is_active %}
                    <div class="alert alert-info mt-4">
                        This auction is closed.
                    {% if user == listing.winner %}
                        <strong>Congratulations, you won the auction!</strong>
                    {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}
